# Pulse AI - n8n Workflow Documentation

## üìã Overview

**Pulse AI** is an automated AI news aggregation and editorial system that:
- Fetches articles from 8 premium AI/tech sources every 3 hours
- Uses AI to analyze, rewrite, and enhance content
- Generates custom editorial images with OpenAI
- Publishes to a JSON-based blog
- Auto-commits to GitHub (triggering Vercel deployment)

---

## üöÄ Quick Start

### 1. Prerequisites

- **n8n installed** (self-hosted or cloud)
- **Node.js 16+** with `xml2js` package
- **Git repository** for your Pulse AI site
- **API Keys:**
  - OpenRouter API key (for Claude Sonnet)
  - OpenAI API key (for image generation)
  - Discord webhook URL (optional, for notifications)

### 2. Install n8n Dependencies

If running n8n locally, ensure `xml2js` is available:

```bash
cd ~/.n8n
npm install xml2js
```

For n8n cloud, the package should be available by default.

### 3. Import the Workflow

1. Open n8n web interface
2. Go to **Workflows** ‚Üí **Import from File**
3. Select `pulse-ai-workflow.json`
4. Workflow will be imported with all nodes configured

---

## üîë Configure Credentials

### OpenRouter API (Claude Sonnet)

1. In n8n, go to **Credentials** ‚Üí **Create New**
2. Select **HTTP Header Auth**
3. Name: `OpenRouter API`
4. Configure:
   - **Header Name:** `Authorization`
   - **Header Value:** `Bearer YOUR_OPENROUTER_API_KEY`

5. Assign this credential to the node: **Claude: Rewrite Article**

### OpenAI API (Image Generation)

1. Create another **HTTP Header Auth** credential
2. Name: `OpenAI API`
3. Configure:
   - **Header Name:** `Authorization`
   - **Header Value:** `Bearer YOUR_OPENAI_API_KEY`

4. Assign to nodes:
   - **OpenAI: Generate Image**

### Discord Webhook (Optional)

1. Create a **Discord Webhook API** credential
2. Get webhook URL from your Discord server:
   - Server Settings ‚Üí Integrations ‚Üí Webhooks ‚Üí New Webhook
3. Paste URL into credential
4. Assign to node: **Discord Notification**

If you don't want Discord notifications, simply disable or delete that node.

---

## üìÇ Directory Setup

The workflow expects this structure:

```
/home/ec2-user/clawd/pulse-ai/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ images/         # AI-generated post images
‚îÇ   ‚îî‚îÄ‚îÄ posts/
‚îÇ       ‚îî‚îÄ‚îÄ posts.json  # Blog posts database
‚îî‚îÄ‚îÄ workflows/
    ‚îú‚îÄ‚îÄ pulse-ai-workflow.json
    ‚îî‚îÄ‚îÄ README.md (this file)
```

**Create directories:**

```bash
mkdir -p /home/ec2-user/clawd/pulse-ai/public/images
mkdir -p /home/ec2-user/clawd/pulse-ai/public/posts
```

**Initialize posts.json:**

```bash
echo "[]" > /home/ec2-user/clawd/pulse-ai/public/posts/posts.json
```

---

## ‚öôÔ∏è Workflow Configuration

### Schedule Trigger

**Default:** Every 3 hours

To change:
1. Open node: **Schedule: Every 3 Hours**
2. Modify interval (e.g., every 2 hours, daily at 9am, etc.)

### RSS Feed Sources

The workflow fetches from:

1. **OpenAI Blog** - https://openai.com/blog/rss.xml
2. **MarkTechPost** - https://www.marktechpost.com/feed/
3. **Hugging Face** - https://huggingface.co/blog/feed.xml
4. **TechCrunch AI** - https://techcrunch.com/category/artificial-intelligence/feed/
5. **VentureBeat AI** - https://venturebeat.com/category/ai/feed/
6. **Google AI Blog** - https://blog.google/technology/ai/rss/
7. **Anthropic** - https://www.anthropic.com/news/rss.xml
8. **ArXiv CS.AI** - http://export.arxiv.org/api/query?search_query=cat:cs.AI

**To add/remove sources:**
- RSS feeds: Add/delete RSS nodes, connect to "Merge All Sources"
- Modify node: **Aggregate & Filter Top 5** to adjust ranking keywords

### Article Selection

**Current settings:**
- Fetches articles from **last 6 hours**
- Selects **top 5** by relevance score
- Deduplicates by title similarity (70% threshold)

**To adjust:**
Edit the **Aggregate & Filter Top 5** code node:
```javascript
const sixHoursAgo = new Date(now - 6 * 60 * 60 * 1000); // Change time window
const top5 = deduplicated.slice(0, 5); // Change number of articles
```

### Image Generation

**Settings:**
- Model: `gpt-image-1.5`
- Quality: `high`
- Size: `1536x1024`

These match the requirements in `TOOLS.md`.

---

## üß™ Testing the Workflow

### Test Run (Manual)

1. Open workflow in n8n
2. Click **Execute Workflow** button
3. Watch nodes execute sequentially
4. Check for errors in any node (red indicators)

### Expected Behavior

- **8 RSS nodes** fetch articles in parallel
- **Merge** combines all sources
- **Top 5** articles selected
- **For each article:**
  - Sentiment analyzed
  - Rewritten by Claude
  - Image generated by OpenAI
  - Saved to disk
- **posts.json** updated
- **Git commit** pushed
- **Discord notification** sent (if configured)

### Verify Output

```bash
# Check posts
cat /home/ec2-user/clawd/pulse-ai/public/posts/posts.json | jq '.[0]'

# Check images
ls -lh /home/ec2-user/clawd/pulse-ai/public/images/

# Check git log
cd /home/ec2-user/clawd/pulse-ai
git log -1
```

---

## üõ†Ô∏è Troubleshooting

### Common Issues

#### 1. "No items from last 6 hours"

**Cause:** RSS feeds might not have fresh content.

**Solution:** 
- Increase time window in **Aggregate & Filter Top 5**
- Or run workflow during peak publishing hours (business hours in US/Europe)

#### 2. ArXiv XML parsing fails

**Cause:** `xml2js` not installed

**Solution:**
```bash
cd ~/.n8n
npm install xml2js
# Restart n8n
```

#### 3. Claude returns invalid JSON

**Cause:** Model occasionally returns malformed JSON

**Solution:** The workflow includes error handling in **Parse & Calculate Read Time**. Check node execution log for details.

**Manual fix:**
- Review Claude's raw response in node output
- Adjust prompt in **Claude: Rewrite Article** to emphasize JSON format

#### 4. Image generation fails

**Cause:** OpenAI API errors or rate limits

**Solution:**
- Check API quota at https://platform.openai.com/usage
- Node has 3 retries with 5s delays built-in

#### 5. Git push fails

**Cause:** Git not configured or no SSH/HTTPS auth

**Solution:**
```bash
cd /home/ec2-user/clawd/pulse-ai
git config user.email "your-email@example.com"
git config user.name "Pulse AI Bot"

# For HTTPS with token:
git remote set-url origin https://YOUR_TOKEN@github.com/username/repo.git

# For SSH:
ssh-keygen -t ed25519
# Add ~/.ssh/id_ed25519.pub to GitHub SSH keys
```

---

## üîß Advanced Customization

### Change Claude Model

Edit **Claude: Rewrite Article** ‚Üí Body Parameters:
```json
{
  "model": "anthropic/claude-3.5-sonnet" // or other models
}
```

Available models: https://openrouter.ai/models

### Adjust Editorial Tone

Edit **Claude: Rewrite Article** ‚Üí Prompt template:
- Modify style instructions
- Change word count (currently 300-500)
- Adjust category options

### Custom Relevance Keywords

Edit **Aggregate & Filter Top 5** ‚Üí `relevanceKeywords` array:
```javascript
const relevanceKeywords = [
  'llm', 'gpt', 'custom-keyword', // Add your keywords
];
```

### Max Posts Limit

Default: 50 posts

Edit **Merge & Limit Posts**:
```javascript
const finalPosts = uniquePosts.slice(0, 50); // Change to 100, 200, etc.
```

---

## üìä Monitoring

### Execution History

n8n automatically logs all executions:
- Go to **Executions** tab
- Filter by workflow name
- Review success/failure status
- Click to see detailed execution flow

### Set Up Alerts

**Option 1: Email on failure**
- Add **Email** node after **Git Commit & Push**
- Configure to send on error
- Use n8n's built-in error workflow triggers

**Option 2: Discord on error**
- Duplicate Discord node
- Set to trigger only on workflow error
- Different message template for errors

---

## üöÄ Production Deployment

### 1. Set Up Cron Alternative (Recommended)

Instead of n8n's built-in schedule, use system cron for reliability:

```bash
crontab -e
```

Add:
```
0 */3 * * * curl -X POST http://localhost:5678/webhook/pulse-ai-trigger
```

Then replace **Schedule Trigger** with **Webhook Trigger** node in n8n.

### 2. Database Backend (Future)

For scale, consider replacing `posts.json` with:
- PostgreSQL
- MongoDB
- Supabase

Add database nodes in place of read/write file operations.

### 3. Image CDN

For production, upload images to:
- Cloudinary
- AWS S3 + CloudFront
- Vercel Blob Storage

Modify **Save Image to Disk** to upload via API instead.

---

## üìù Workflow Architecture

```
Schedule (every 3h)
    ‚Üì
[8 Parallel RSS Fetches] ‚Üí Merge
    ‚Üì
Aggregate & Filter (top 5)
    ‚Üì
[For Each Article]
    ‚Üì
Sentiment Analysis
    ‚Üì
Claude Rewrite
    ‚Üì
Parse & Calculate Read Time
    ‚Üì
OpenAI Generate Image
    ‚Üì
Download & Save Image
    ‚Üì
Build Post Object
    ‚Üì
[Collect All Posts]
    ‚Üì
Merge with Existing Posts
    ‚Üì
Write posts.json
    ‚Üì
Git Commit & Push
    ‚Üì
Discord Notification
```

---

## üéØ Next Steps

1. **Import workflow** ‚Üí Configure credentials ‚Üí Test run
2. **Populate initial content** (see testing section below)
3. **Connect GitHub repo** and configure Vercel
4. **Enable schedule trigger**
5. **Monitor first few runs**

---

## üß™ Initial Content Population

To test and populate the site with content immediately:

```bash
# Run the test script (see test-workflow.md)
cd /home/ec2-user/clawd/pulse-ai/workflows
node test-runner.js
```

Or manually trigger the workflow 2-3 times to build up content.

---

## üìû Support

**Issues with workflow:**
- Check n8n execution logs
- Review this documentation
- Verify all credentials are set

**Issues with APIs:**
- OpenRouter: https://openrouter.ai/docs
- OpenAI: https://platform.openai.com/docs

**General n8n help:**
- Official docs: https://docs.n8n.io
- Community forum: https://community.n8n.io

---

## üìÑ License

This workflow is part of the Pulse AI project. Modify and use freely.

---

**Last updated:** 2025-01-15
**Workflow version:** 1.0
**Tested with:** n8n v1.x
